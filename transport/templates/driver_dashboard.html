<!DOCTYPE html>
{% load static %}
<html>
<head>
<title>K-BUS | Driver Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --secondary: #f59e0b;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --dark: #1e293b;
    --light: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: var(--gray-800);
    line-height: 1.5;
}

header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-lg);
    border-bottom: 3px solid var(--secondary);
}

header div:first-child {
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-badge {
    background: var(--gray-100);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-xl);
    font-weight: 600;
    color: var(--primary);
    border: 2px solid var(--primary);
}

.section {
    width: 90%;
    max-width: 1200px;
    margin: 2rem auto;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    padding: 2rem;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.section h2 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--gray-800);
    position: relative;
    padding-bottom: 0.75rem;
}

.section h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: var(--radius-sm);
}

.row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--radius-xl);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    color: var(--gray-700);
    border: 2px solid var(--gray-200);
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white;
    border: none;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, var(--danger));
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.btn-outline.active {
    background: var(--primary);
    color: white;
}

.pill {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.9rem;
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-200);
}

.pill i {
    margin-right: 0.5rem;
    font-size: 1rem;
}

.pill.trip-active {
    background: #d1fae5;
    color: #065f46;
    border-color: #10b981;
}

.pill.trip-inactive {
    background: #fff7ed;
    color: #9a3412;
    border-color: #f59e0b;
}

.bus-info {
    background: var(--gray-100);
    padding: 1rem;
    border-radius: var(--radius-xl);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
    margin: 1rem 0;
}

.bus-info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
}

.bus-info-item i {
    color: var(--primary);
    font-size: 1.1rem;
}

.bus-info-item strong {
    color: var(--gray-800);
    margin-right: 0.25rem;
}

#driver_map {
    height: 400px;
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    margin: 1.5rem 0;
    border: 3px solid white;
}

.info-panel {
    background: var(--gray-100);
    padding: 1.5rem;
    border-radius: var(--radius-xl);
    margin: 1rem 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.info-item {
    background: white;
    padding: 1rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-800);
}

.info-value.highlight {
    color: var(--primary);
}

hr {
    margin: 2rem 0;
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gray-300), transparent);
}

h3 {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--gray-800);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

h3 i {
    color: var(--primary);
}

.table-container {
    overflow-x: auto;
    border-radius: var(--radius-lg);
    background: white;
    box-shadow: var(--shadow-lg);
    margin: 1rem 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
}

th {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    font-weight: 600;
    padding: 1rem;
    text-align: left;
    font-size: 0.9rem;
}

td {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-200);
    color: var(--gray-700);
}

tr:hover td {
    background: var(--gray-100);
}

.total-collection {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
    padding: 1rem 2rem;
    border-radius: var(--radius-xl);
    display: inline-block;
    font-weight: 700;
    font-size: 1.5rem;
    margin-top: 1rem;
    box-shadow: var(--shadow-md);
}

.total-collection span {
    font-size: 2rem;
    margin-left: 0.5rem;
}

.no-data {
    text-align: center;
    padding: 3rem;
    color: var(--gray-500);
    font-style: italic;
}

.no-data i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

small {
    color: var(--gray-500);
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    header {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }
    
    .section {
        padding: 1.5rem;
    }
    
    .bus-info {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn {
        flex: 1;
        justify-content: center;
    }
    
    .info-panel {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body data-bus-id="{% if bus %}{{ bus.id }}{% endif %}" data-trip-active="{% if bus and bus.trip_active %}1{% else %}0{% endif %}">

<header>
    <div><i class="fas fa-bus" style="margin-right: 10px;"></i>K-BUS Driver Panel</div>
    <div class="header-right">
        <div class="user-badge"><i class="fas fa-user-circle" style="margin-right: 8px;"></i>{% if request.user.is_authenticated %}{{ request.user.username }}{% endif %}</div>
        <a href="{% url 'logout' %}" class="btn btn-danger" style="padding: 0.6rem 1rem; font-size: 0.9rem; flex: 0 0 auto;">
            <i class="fas fa-sign-out-alt"></i>LOGOUT
        </a>
    </div>
</header>

<div class="section">
    <h2><i class="fas fa-tachometer-alt" style="margin-right: 12px; color: var(--primary);"></i>Driver Dashboard</h2>

    {% if not bus %}
        <div style="text-align: center; padding: 3rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: var(--danger); margin-bottom: 1rem;"></i>
            <p style="color: var(--danger); font-weight: 600; font-size: 1.25rem;">No bus is linked to this driver account.</p>
            <p style="color: var(--gray-500); margin-top: 0.5rem;">Please contact the administrator.</p>
        </div>
    {% else %}
        <div class="btn-group" style="margin-bottom: 1.5rem;">
            <button type="button" class="btn btn-outline active" id="tabLive"><i class="fas fa-play-circle"></i>LIVE PANEL</button>
            <button type="button" class="btn btn-outline" id="tabTrips"><i class="fas fa-history"></i>TRIP DETAILS</button>
        </div>

        <div id="livePanel">
            <div class="bus-info">
                <div class="bus-info-item">
                    <i class="fas fa-bus"></i>
                    <span><strong>Bus:</strong> {{ bus.vehicle_number }}</span>
                </div>
                <div class="bus-info-item">
                    <i class="fas fa-key"></i>
                    <span><strong>OTP:</strong> {{ bus.otp_code }}</span>
                </div>
                {% if bus.trip_active %}
                    <div class="pill trip-active">
                        <i class="fas fa-play"></i>TRIP ACTIVE
                    </div>
                {% else %}
                    <div class="pill trip-inactive">
                        <i class="fas fa-stop"></i>TRIP NOT STARTED
                    </div>
                {% endif %}
            </div>

            <div class="btn-group" style="margin-bottom: 1rem;">
                {% if not bus.trip_active %}
                    <a href="{% url 'start_trip' bus.id %}" class="btn btn-primary">
                        <i class="fas fa-play"></i>START TRIP
                    </a>
                    <small><i class="fas fa-info-circle" style="color: var(--gray-500);"></i> GPS updates start after trip begins</small>
                {% else %}
                    <a href="{% url 'end_trip' bus.id %}" class="btn btn-danger">
                        <i class="fas fa-stop"></i>END TRIP
                    </a>
                    <small><i class="fas fa-satellite-dish" style="color: var(--success);"></i> GPS sending every 5 seconds</small>
                {% endif %}
            </div>

            <hr>

            <h3><i class="fas fa-map-marker-alt"></i>Live Location</h3>
            <div id="driver_map"></div>

            <div id="driver_info" class="info-panel"></div>

            {% if bus.trip_active %}
                <hr>
                <h3><i class="fas fa-ticket-alt"></i>Trip Tickets</h3>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Fare</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="tripTicketsBody">
                            {% for t in tickets %}
                                <tr>
                                    <td><span class="badge">#{{ t.id }}</span></td>
                                    <td><i class="fas fa-circle" style="color: var(--success); font-size: 8px; margin-right: 5px;"></i>{{ t.source_stop }}</td>
                                    <td><i class="fas fa-circle" style="color: var(--danger); font-size: 8px; margin-right: 5px;"></i>{{ t.destination_stop }}</td>
                                    <td><span class="fare-badge">₹{{ t.fare }}</span></td>
                                    <td>{{ t.created_at|date:"H:i" }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="5" class="no-data">
                                        <i class="fas fa-ticket-alt"></i>
                                        <p>No tickets yet for this trip</p>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="total-collection">
                    <i class="fas fa-coins"></i> Total Collection: <span id="totalAmount">₹{{ total_amount }}</span>
                </div>
            {% endif %}
        </div>

        <div id="tripDetails" style="display:none;">
            <h3><i class="fas fa-clock"></i>Trip History</h3>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Trip ID</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tr in trips %}
                            <tr>
                                <td><span class="badge">#{{ tr.id }}</span></td>
                                <td>{{ tr.start_time|date:"d M Y H:i" }}</td>
                                <td>
                                    {% if tr.end_time %}
                                        {{ tr.end_time|date:"d M Y H:i" }}
                                    {% else %}
                                        <span class="pill trip-active" style="font-size: 0.8rem;">Active</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if tr.end_time %}
                                        <span class="pill" style="background: var(--gray-200);">Completed</span>
                                    {% else %}
                                        <span class="pill trip-active">In Progress</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn viewTripBtn" style="padding: 0.5rem 1rem;" data-trip-id="{{ tr.id }}">
                                        <i class="fas fa-eye"></i> VIEW
                                    </button>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="5" class="no-data">
                                    <i class="fas fa-history"></i>
                                    <p>No trips yet</p>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <hr>

            <h3><i class="fas fa-ticket-alt"></i>Trip Tickets</h3>
            <div id="tripMeta" class="info-panel" style="grid-template-columns: 1fr;"></div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Fare</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="historyTicketsBody">
                        <tr>
                            <td colspan="5" class="no-data">
                                <i class="fas fa-hand-pointer"></i>
                                <p>Select a trip to view tickets</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="total-collection">
                <i class="fas fa-coins"></i> Trip Collection: <span id="historyTotal">₹0</span>
            </div>
        </div>
    {% endif %}
</div>

<style>
.badge {
    background: var(--gray-200);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--gray-700);
}

.fare-badge {
    background: var(--success);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
}

.viewTripBtn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.viewTripBtn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}
</style>

<script>
(function(){
    // -----------------------------
    // Trip VIEW utilities (must work even if Leaflet/CDNs fail)
    // -----------------------------
    function fmtIstDateTime(value){
        if(!value){
            return '';
        }
        try{
            return new Date(value).toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
            });
        }catch(e){
            return '';
        }
    }

    function fmtIstTime(value){
        if(!value){
            return '';
        }
        try{
            return new Date(value).toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
            });
        }catch(e){
            return '';
        }
    }

    function setTripError(message){
        var bodyEl = document.getElementById('historyTicketsBody');
        var totalEl = document.getElementById('historyTotal');
        var metaEl = document.getElementById('tripMeta');
        if(bodyEl){
            bodyEl.innerHTML = '<tr><td colspan="5" class="no-data"><i class="fas fa-exclamation-circle"></i><p>' + String(message || 'Unable to load trip') + '</p></td></tr>';
        }
        if(totalEl){
            totalEl.innerText = '₹0';
        }
        if(metaEl){
            metaEl.innerHTML = '';
        }
    }

    function parseJsonResponse(res){
        // Handles cases where backend returns HTML (login redirect) or plain text.
        var ct = (res && res.headers && res.headers.get) ? (res.headers.get('content-type') || '') : '';
        if(ct.indexOf('application/json') !== -1){
            return res.json();
        }
        return res.text().then(function(txt){
            return {
                __nonJson: true,
                status: res.status,
                statusText: res.statusText,
                text: txt
            };
        });
    }

    window.loadTrip = function(tripId){
        // Immediate UI feedback
        var bodyEl = document.getElementById('historyTicketsBody');
        if(bodyEl){
            bodyEl.innerHTML = '<tr><td colspan="5" class="no-data"><i class="fas fa-spinner fa-spin"></i><p>Loading trip…</p></td></tr>';
        }

        fetch('/transport/driver-trip/' + encodeURIComponent(tripId) + '/')
            .then(function(res){
                return parseJsonResponse(res).then(function(data){
                    return { res: res, data: data };
                });
            })
            .then(function(r){
                var res = r.res;
                var data = r.data;

                if(data && data.__nonJson){
                    if(res.status === 302 || res.status === 301 || res.status === 0){
                        setTripError('Session expired. Please login again.');
                    } else {
                        setTripError('Server returned non-JSON response (HTTP ' + res.status + ').');
                    }
                    return;
                }

                if(!res.ok){
                    var msg = (data && data.error) ? data.error : ('HTTP ' + res.status);
                    setTripError(msg);
                    return;
                }

                var totalEl = document.getElementById('historyTotal');
                var metaEl = document.getElementById('tripMeta');
                var bodyEl2 = document.getElementById('historyTicketsBody');
                if(!bodyEl2 || !totalEl || !metaEl){
                    return;
                }

                if(data && data.error){
                    setTripError(data.error);
                    return;
                }

                var startText = fmtIstDateTime(data.start_time);
                var endText = data.end_time ? fmtIstDateTime(data.end_time) : 'Active';
                metaEl.innerHTML = (
                    '<div class="info-item">'
                    + '<span class="info-label">Trip #' + String(data.trip_id || '') + '</span>'
                    + '<span class="info-value">' + startText + ' - ' + endText + '</span>'
                    + '</div>'
                );

                totalEl.innerText = '₹' + ((data.total_amount == null) ? '0' : data.total_amount);

                if(!data.tickets || data.tickets.length === 0){
                    bodyEl2.innerHTML = '<tr><td colspan="5" class="no-data"><i class="fas fa-ticket-alt"></i><p>No tickets for this trip</p></td></tr>';
                    showTab('trips');
                    return;
                }

                var rows = '';
                for(var i=0;i<data.tickets.length;i++){
                    var t = data.tickets[i];
                    var timeText = fmtIstDateTime(t.created_at);
                    rows += '<tr>' +
                        '<td><span class="badge">#' + t.id + '</span></td>' +
                        '<td><i class="fas fa-circle" style="color: var(--success); font-size: 8px; margin-right: 5px;"></i>' + (t.source_stop || '') + '</td>' +
                        '<td><i class="fas fa-circle" style="color: var(--danger); font-size: 8px; margin-right: 5px;"></i>' + (t.destination_stop || '') + '</td>' +
                        '<td><span class="fare-badge">₹' + (t.fare == null ? '' : t.fare) + '</span></td>' +
                        '<td>' + timeText + '</td>' +
                    '</tr>';
                }
                bodyEl2.innerHTML = rows;
                showTab('trips');
            })
            .catch(function(err){
                setTripError('Network error while loading trip');
                try{ console.error(err); }catch(e){}
            });
    };

    // -----------------------------
    // Leaflet setup (optional)
    // -----------------------------
    var KBUS_YELLOW_ICON = null;
    if(window.L && L.icon){
        var __kbusYellowSvg = (
            '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="45" viewBox="0 0 30 45">'
            + '<path d="M15 44.5C15 44.5 27.5 29.8 27.5 15.4C27.5 6.9 21.9 0.5 15 0.5C8.1 0.5 2.5 6.9 2.5 15.4C2.5 29.8 15 44.5 15 44.5Z" fill="#f59e0b" stroke="#b45309" stroke-width="1.5"/>'
            + '<circle cx="15" cy="15.5" r="6.2" fill="#ffffff" opacity="0.95"/>'
            + '</svg>'
        );
        // Note: keep icon embedded so it works even if /static isn't served.
        KBUS_YELLOW_ICON = L.icon({
            iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(__kbusYellowSvg),
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -42],
        });
    }

    // Ensure Leaflet's default marker icons load correctly (prevents "invisible" markers
    // when marker PNG assets can't be resolved).
    try {
        if (window.L && L.Icon && L.Icon.Default) {
            L.Icon.Default.mergeOptions({
                iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            });
        }
    } catch (e) {
        // no-op
    }

    var busIdRaw = (document.body.dataset.busId || '').trim();
    var busId = busIdRaw ? parseInt(busIdRaw, 10) : null;
    var tripActive = (document.body.dataset.tripActive || '0') === '1';

    // NOTE: Trip history VIEW does not require busId.
    // Only map/live polling requires a valid numeric busId.
    var busIdOk = (typeof busId === 'number' && !isNaN(busId));

    var map = null;
    if(busIdOk && window.L && L.map){
        map = L.map('driver_map').setView([11.75,75.57],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    }

    // Overlay your custom K-BUS route map (KML)
    if(busIdOk && map){
        try{
            var __kbusRouteGeoJson = L.geoJson(null, {
                pointToLayer: function(feature, latlng){
                    if(KBUS_YELLOW_ICON){
                        return L.marker(latlng, { icon: KBUS_YELLOW_ICON });
                    }
                    return L.marker(latlng);
                }
            });

            var __kbusRouteLayer = omnivore.kml("{% url 'kbus_route_kml' %}", null, __kbusRouteGeoJson)
            .on('ready', function(){
                // Fit once so route is visible even before GPS updates
                if(!window.__kbusDriverRouteFitted){
                    window.__kbusDriverRouteFitted = true;
                    try{ map.fitBounds(__kbusRouteLayer.getBounds()); }catch(e){}
                }
            })
            .addTo(map);
        }catch(e){
            // If omnivore fails to load, base map still works
        }
    }

    var marker;
    var infoEl = document.getElementById('driver_info');

    function updateInfo(data){
        if(!infoEl){
            return;
        }
        var speedMps = (data.speed == null) ? null : Number(data.speed);
        var speedKmh = (speedMps == null || isNaN(speedMps)) ? null : (speedMps * 3.6);
        var updatedText = data.time ? fmtIstDateTime(data.time) : '—';
        var speedText = (speedKmh == null) ? '—' : speedKmh.toFixed(1) + ' km/h';

        infoEl.innerHTML = `
            <div class="info-item">
                <span class="info-label"><i class="fas fa-clock"></i> Last Update</span>
                <span class="info-value">${updatedText}</span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-tachometer-alt"></i> Speed</span>
                <span class="info-value highlight">${speedText}</span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-map-pin"></i> Current Stop</span>
                <span class="info-value">${data.current_stop || '—'}</span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-arrow-right"></i> Next Stop</span>
                <span class="info-value">${data.next_stop || '—'}</span>
            </div>
            <div class="info-item">
                <span class="info-label"><i class="fas fa-hourglass-half"></i> ETA</span>
                <span class="info-value highlight">${(data.eta_minutes == null) ? '—' : data.eta_minutes + ' min'}</span>
            </div>
        `;
    }

    function pollLocation(){
        if(!busIdOk || !map){
            return;
        }
        fetch('/transport/bus-location/' + busId + '/')
            .then(function(res){ return res.json(); })
            .then(function(data){
                if(data.lat && data.lng){
                    if(marker){
                        marker.setLatLng([data.lat, data.lng]);
                    } else {
                        marker = KBUS_YELLOW_ICON
                            ? L.marker([data.lat, data.lng], { icon: KBUS_YELLOW_ICON }).addTo(map)
                            : L.marker([data.lat, data.lng]).addTo(map);
                    }
                    map.panTo([data.lat, data.lng]);
                }
                updateInfo(data);
            })
            .catch(function(){
                // ignore
            });
    }

    function sendLocation(position){
        if(!busIdOk || !map){
            return;
        }
        if(!tripActive){
            return;
        }

        var lat = position.coords.latitude;
        var lng = position.coords.longitude;
        var speed = (position.coords.speed == null) ? 0 : position.coords.speed;

        if(marker){
            marker.setLatLng([lat, lng]);
        } else {
            marker = KBUS_YELLOW_ICON
                ? L.marker([lat, lng], { icon: KBUS_YELLOW_ICON }).addTo(map)
                : L.marker([lat, lng]).addTo(map);
        }
        map.panTo([lat, lng]);

        fetch('/transport/update-location/' + busId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'lat=' + encodeURIComponent(lat) + '&lng=' + encodeURIComponent(lng) + '&speed=' + encodeURIComponent(speed)
        }).then(function(){
            pollLocation();
        });
    }

    function geoError(){
        // no-op
    }

    function pollTrip(){
        if(!busIdOk){
            return;
        }
        if(!tripActive){
            return;
        }

        fetch('/transport/driver-trip-summary/' + busId + '/')
            .then(function(res){ return res.json(); })
            .then(function(data){
                if(!data || data.trip_active !== true){
                    return;
                }

                var bodyEl = document.getElementById('tripTicketsBody');
                var totalEl = document.getElementById('totalAmount');
                if(!bodyEl || !totalEl){
                    return;
                }

                totalEl.innerText = '₹' + ((data.total_amount == null) ? '0' : data.total_amount);

                if(!data.tickets || data.tickets.length === 0){
                    bodyEl.innerHTML = '<tr><td colspan="5" class="no-data"><i class="fas fa-ticket-alt"></i><p>No tickets yet for this trip</p></td></tr>';
                    return;
                }

                var rows = '';
                for(var i=0;i<data.tickets.length;i++){
                    var t = data.tickets[i];
                    var timeText = fmtIstTime(t.created_at);
                    rows += '<tr>' +
                        '<td><span class="badge">#' + t.id + '</span></td>' +
                        '<td><i class="fas fa-circle" style="color: var(--success); font-size: 8px; margin-right: 5px;"></i>' + (t.source_stop || '') + '</td>' +
                        '<td><i class="fas fa-circle" style="color: var(--danger); font-size: 8px; margin-right: 5px;"></i>' + (t.destination_stop || '') + '</td>' +
                        '<td><span class="fare-badge">₹' + (t.fare == null ? '' : t.fare) + '</span></td>' +
                        '<td>' + timeText + '</td>' +
                    '</tr>';
                }
                bodyEl.innerHTML = rows;
            })
            .catch(function(){
                // ignore
            });
    }

    function showTab(tab){
        var live = document.getElementById('livePanel');
        var trips = document.getElementById('tripDetails');
        var tabLive = document.getElementById('tabLive');
        var tabTrips = document.getElementById('tabTrips');
        
        if(!live || !trips) return;
        
        if(tab === 'trips'){
            live.style.display = 'none';
            trips.style.display = 'block';
            tabLive.classList.remove('active');
            tabTrips.classList.add('active');
        } else {
            trips.style.display = 'none';
            live.style.display = 'block';
            tabTrips.classList.remove('active');
            tabLive.classList.add('active');
        }
    }

    // NOTE: window.loadTrip is defined at the top of this script

    // Tabs
    var tabLiveBtn = document.getElementById('tabLive');
    var tabTripsBtn = document.getElementById('tabTrips');
    if(tabLiveBtn){
        tabLiveBtn.addEventListener('click', function(){ showTab('live'); });
    }
    if(tabTripsBtn){
        tabTripsBtn.addEventListener('click', function(){ showTab('trips'); });
    }

    // Trip view buttons
    Array.prototype.forEach.call(document.querySelectorAll('.viewTripBtn'), function(btn){
        btn.addEventListener('click', function(e){
            if(e && e.preventDefault){
                e.preventDefault();
                e.stopPropagation();
            }
            var tripId = (btn.getAttribute('data-trip-id') || '').trim();
            if(tripId){
                window.loadTrip(tripId);
            }
        });
    });

    if(busIdOk){
        // Always poll location so driver sees live location even before starting trip
        pollLocation();
        setInterval(pollLocation, 5000);

        // Auto-refresh trip tickets and total
        pollTrip();
        setInterval(pollTrip, 5000);

        // Start GPS sending only during active trip
        if(tripActive && navigator.geolocation){
            setInterval(function(){
                navigator.geolocation.getCurrentPosition(sendLocation, geoError);
            }, 5000);
        }
    }
})();
</script>

</body>
</html>