<style>
  /* K-BUS Support Chat (minimal, page-local) */
  #kbusSupportFab {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9999;
    border: 0;
    border-radius: 999px;
    padding: 0.75rem 1rem;
    font-weight: 700;
    cursor: pointer;
    background: var(--primary);
    color: white;
  }

  #kbusSupportPanel {
    position: fixed;
    right: 18px;
    bottom: 72px;
    z-index: 9999;
    width: min(360px, calc(100vw - 36px));
    max-height: 60vh;
    display: none;
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    overflow: hidden;
  }

  #kbusSupportHeader {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0.9rem;
    background: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
    font-weight: 800;
    color: var(--gray-800);
  }

  #kbusSupportBody {
    padding: 0.75rem;
    overflow: auto;
    max-height: calc(60vh - 110px);
  }

  .kbusMsg {
    padding: 0.6rem 0.75rem;
    border-radius: var(--radius-lg);
    margin-bottom: 0.5rem;
    border: 1px solid var(--gray-200);
    color: var(--gray-800);
    background: white;
    white-space: pre-wrap;
  }
  .kbusMsg.user {
    border-color: var(--primary);
  }
  .kbusMsg.bot {
    background: var(--gray-100);
  }

  #kbusSupportFooter {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    border-top: 1px solid var(--gray-200);
    background: white;
  }

  #kbusSupportInput {
    flex: 1;
    padding: 0.6rem 0.75rem;
    border-radius: var(--radius-lg);
    border: 2px solid var(--gray-200);
    outline: none;
  }

  #kbusSupportSend {
    border: 0;
    border-radius: var(--radius-lg);
    padding: 0.6rem 0.9rem;
    font-weight: 700;
    cursor: pointer;
    background: var(--primary);
    color: white;
  }
</style>

<button id="kbusSupportFab" type="button" aria-label="Open support chat">HELP</button>

<div id="kbusSupportPanel" role="dialog" aria-label="K-BUS Support">
  <div id="kbusSupportHeader">
    <span>Support</span>
    <button id="kbusSupportClose" type="button" style="border:0;background:transparent;cursor:pointer;font-weight:800;color:var(--gray-700);">✕</button>
  </div>
  <div id="kbusSupportBody">
    <div class="kbusMsg bot">Hi! Ask me about OTP, booking, fare, ticket expiry, or tracking.</div>
  </div>
  <div id="kbusSupportFooter">
    <input id="kbusSupportInput" type="text" placeholder="Type your question…" autocomplete="off" />
    <button id="kbusSupportSend" type="button">Send</button>
  </div>
</div>

<script>
(function(){
  var fab = document.getElementById('kbusSupportFab');
  var panel = document.getElementById('kbusSupportPanel');
  var closeBtn = document.getElementById('kbusSupportClose');
  var body = document.getElementById('kbusSupportBody');
  var input = document.getElementById('kbusSupportInput');
  var sendBtn = document.getElementById('kbusSupportSend');

  if(!fab || !panel || !closeBtn || !body || !input || !sendBtn){
    return;
  }

  function kbusGetCookie(name){
    try{
      var cookieValue = null;
      if(document.cookie && document.cookie !== ''){
        var cookies = document.cookie.split(';');
        for(var i=0;i<cookies.length;i++){
          var cookie = cookies[i].trim();
          if(cookie.substring(0, name.length + 1) === (name + '=')){
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }catch(e){
      return null;
    }
  }

  function addMsg(text, cls){
    var el = document.createElement('div');
    el.className = 'kbusMsg ' + (cls || 'bot');
    el.textContent = String(text || '');
    body.appendChild(el);
    body.scrollTop = body.scrollHeight;
  }

  function toggle(open){
    var show = (open === true) ? true : (panel.style.display === 'none' || !panel.style.display);
    panel.style.display = show ? 'block' : 'none';
    if(show){
      setTimeout(function(){ try{ input.focus(); }catch(e){} }, 0);
    }
  }

  fab.addEventListener('click', function(){ toggle(); });
  closeBtn.addEventListener('click', function(){ toggle(false); });

  function send(){
    var msg = (input.value || '').trim();
    if(!msg){
      return;
    }

    input.value = '';
    addMsg(msg, 'user');
    addMsg('…', 'bot');

    var csrftoken = kbusGetCookie('csrftoken');

    fetch('/transport/chat/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken || ''
      },
      body: JSON.stringify({ message: msg })
    })
    .then(function(res){
      return res.json().catch(function(){ return { error: 'Invalid server response' }; }).then(function(data){
        return { ok: res.ok, status: res.status, data: data };
      });
    })
    .then(function(r){
      // remove the last placeholder “…” message
      try{ body.removeChild(body.lastElementChild); }catch(e){}

      if(!r.ok){
        addMsg((r.data && r.data.error) ? r.data.error : ('Error (HTTP ' + r.status + ')'), 'bot');
        return;
      }
      addMsg((r.data && r.data.reply) ? r.data.reply : 'No reply', 'bot');
    })
    .catch(function(){
      try{ body.removeChild(body.lastElementChild); }catch(e){}
      addMsg('Network error. Please try again.', 'bot');
    });
  }

  sendBtn.addEventListener('click', send);
  input.addEventListener('keydown', function(e){
    if(e && e.key === 'Enter'){
      e.preventDefault();
      send();
    }
  });
})();
</script>
